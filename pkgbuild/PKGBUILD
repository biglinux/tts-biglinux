# Maintainer: Bruno Goncalves <bigbruno@gmail.com>

pkgname=tts-biglinux
pkgver=$(date +%y.%m.%d)
pkgrel=$(date +%H%M)
arch=('any')
license=('GPL')
url="https://github.com/biglinux/tts-biglinux"
pkgdesc="Text to speech with graphical configuration and very easy to use"
depends=(
    'python'
    'python-gobject'
    'gtk4'
    'libadwaita'
    'speech-dispatcher'
    'espeak-ng'
    'xsel'
    'wl-clipboard-rs'
    'alsa-utils'
)
optdepends=(
    'rhvoice: high-quality multilingual TTS engine'
    'rhvoice-voice-leticia-f123: Brazilian Portuguese female voice'
    'rhvoice-voice-evgeniy-eng: English male voice'
    'rhvoice-brazilian-portuguese-complementary-dict-biglinux: dictionary complement'
    'piper-tts-bin: neural TTS engine (high quality, offline)'
    'piper-voices-pt-BR: Brazilian Portuguese neural voices for Piper'
    'sox: volume control for Piper audio output'
)
source=("git+https://github.com/biglinux/tts-biglinux.git")
md5sums=(SKIP)

package() {
    # Verify default folder
    if [ -d "${srcdir}/${pkgname}/${pkgname}" ]; then
        InternalDir="${srcdir}/${pkgname}/${pkgname}"
    else
        InternalDir="${srcdir}/${pkgname}"
    fi

    # Detect Python version for site-packages
    local _pyver
    _pyver=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')

    # Install Python module
    install -d "${pkgdir}/usr/lib/python${_pyver}/site-packages/"
    if [ -d "${InternalDir}/src/biglinux_tts" ]; then
        cp -r "${InternalDir}/src/biglinux_tts" "${pkgdir}/usr/lib/python${_pyver}/site-packages/"
    fi

    # Install executables
    install -d "${pkgdir}/usr/bin"
    if [ -d "${InternalDir}/usr/bin" ]; then
        install -m755 "${InternalDir}/usr/bin/"* "${pkgdir}/usr/bin/"
    fi

    # Install share files (desktop entries, icons, locale)
    if [ -d "${InternalDir}/usr/share" ]; then
        cp -r "${InternalDir}/usr/share" "${pkgdir}/usr/"
    fi

    # Install .po translation files
    if [ -d "${InternalDir}/locale" ]; then
        install -d "${pkgdir}/usr/share/tts-biglinux/locale"
        install -m644 "${InternalDir}/locale/"*.po \
            "${pkgdir}/usr/share/tts-biglinux/locale/"
    fi

    # KDE global shortcut link
    mkdir -p "${pkgdir}/usr/share/kglobalaccel/"
    ln -s "/usr/share/applications/bigtts.desktop" \
        "${pkgdir}/usr/share/kglobalaccel/bigtts.desktop"

    # KHotkeys config for Plasma 5 compatibility
    if [ -d "${InternalDir}/usr/share/khotkeys" ]; then
        mkdir -p "${pkgdir}/usr/share/khotkeys/"
        install -m644 "${InternalDir}/usr/share/khotkeys/"* \
            "${pkgdir}/usr/share/khotkeys/"
    fi

    # Icon compatibility symlink (old name â†’ new name)
    mkdir -p "${pkgdir}/usr/share/icons/hicolor/scalable/apps/"
    if [ -f "${pkgdir}/usr/share/icons/hicolor/scalable/apps/biglinux-tts.svg" ] && \
       [ ! -f "${pkgdir}/usr/share/icons/hicolor/scalable/apps/tts-biglinux.svg" ]; then
        ln -s "biglinux-tts.svg" \
            "${pkgdir}/usr/share/icons/hicolor/scalable/apps/tts-biglinux.svg"
    fi
}
